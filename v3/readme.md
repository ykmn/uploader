Uploader 3.06.000
==================
23.12.2024 Roman Ermakov <r.ermakov@emg.fm>

Программа предназначена для обработки XML-файла с метаданными от DJin в формате [3.0 Расширенный](https://redmine.digispot.ru/projects/digispot/wiki/%D0%A7%D1%82%D0%BE_%D0%B8%D0%B3%D1%80%D0%B0%D0%B5%D1%82_%D0%B2_%D0%BF%D0%BB%D0%B5%D0%B5%D1%80%D0%B5_%D0%B2_%D0%B2%D0%B8%D0%B4%D0%B5_XML_v_3_0) и отправки метаданных различным получателям.
В качестве получателей метаданных могут выступать:

* JSONCUSTOM: отправка JSON в специальном формате на сервер хостинга. Метаданные будут преобразованы в JSON с текущей и следующими по плейлисту песнями в следующем виде:
```JSON
{
"stream":  "myradio.cfg",
"songs":  [
	{ "artist":  "Arilena Ara", "runtime":  149, "dbID":  "151597", "ELEM":  0, "title":  "Nentori (Beverly Pills Remix)", "starttime":  1500984064 },
	{ "artist":  "Nickelback", "runtime":  197, "dbID":  "1274", "ELEM":  2, "title":  "If Everyone Cared", "starttime":  1500984223 },
	{ "artist":  "Charlie Puth", "runtime":  203, "dbID":  "152322", "ELEM":  5, "title":  "Attention", "starttime":  1500984426 }
	]
}
```

* JSONLOCAL: сохранение JSON в специальном формате в локальную папку.
* POST: отправка исходного XML без преобразования в виде POST-запроса на сервер.
* FTP: отправка исходного XML без преобразования на FTP-сервер.
* PROSTREAM: отправка строки с Artist-Title в энкодер Omnia Z/IPStream или ProStream.
* RDS: отправка строки Artist-Title в RDS-кодер DEVA SmartGen, Orban 8700 или в LinkShare.

Количество получателей в каждой категории (кроме JSONLOCAL) неограничено.

Файл конфигурации example.cfg.json:
---------------------------
```json
{
    "XMLf":"\\\\server\\share\\XML\\UPLOAD\\EP-MSK2v3.xml",
    "rArtistID":"8",
    "rTitleID":"19",
    "altArtistID":"8",
    "altTitleID":"19",
    "_comment1":"EP: 8/19/FALSE/8/19; RR: 7/17/TRUE/7/17; R7: 0/0/FALSE/0/0; DR: 7/17/FALSE/0/0",
    "DefaultAT":"ru",
    "_comment2":"если ru, то брать AT для RDS из пользовательских атрибутов",
    "AltAT":"false",
    "_comment3":"если TRUE, то в основных атрибутах находится транслит, а в пользовательских - русские AT, если FALSE, то основных атрибутах находятся русские AT",
    "jsonlocal":true,
    "ftp": [
        {
            "pass": "password",
            "path": "/",
            "server": "127.0.0.1",
            "user": "anonymous"
        },
        {
            "pass": "password",
            "path": "/ftp/",
            "server": "localhost:21",
            "user": "radio"
        }
    ],
    "jsoncustom": [
        {
            "jsonserver": "https://127.0.0.1:8080/handler"
        }
    ],
    "post": [
        {
            "server": "https://webhook.site/e362b6bf-d73b-4f5d-9697-092e23a4b102",
            "token": "1234567890"
        },
        {
            "server": "https://webhook.site/e362b6bf-d73b-4f5d-9697-092e23a4b102",
            "token": "0987654321"
        },
        {
            "server": "https://localhost:8089/post?priority=3",
            "token": "abcdefghijklmnopqrstuvwxyz"
        }
    ],
    "prostream": [
        {
            "port": "6002",
            "server": "localhost"
        },
        {
            "port": "6002",
            "server": "127.0.0.1"
        }
    ],
    "rds": [
        {
            "commercialText": "Reklama: +7(495)620-4664",
            "device": "SmartGen",
            "address": "localhost",
            "NonMusic": "Europa Plus Moscow",
            "port": "5001",
            "porttype": "UDP",
            "site": "www.europaplus.ru"
        },
        {
            "commercialText": "Reklama: +7(495)620-4664",
            "device": "LinkShare",
            "address": "127.0.0.1",
            "NonMusic": "Europa Plus Moscow",
            "port": "5000",
            "porttype": "TCP",
            "site": "www.europaplus.ru"
        }

    ]
}

```

* `XMLf` - путь к XML-файлу Джина. ВАЖНО: каждый обратный слэш должен быть удвоен (`C:\\FOLDER\\cur_playing.xml`)

* `jsonlocal` - true, false (если категория не нужна). Файл example.cfg.local.json сохраняется в .jsons

* `jsoncustom` - может быть массивом: добавьте ещё один набор параметров в {}, удалите все наборы {} если категория не нужна.

* `post` - может быть массивом: добавьте ещё один набор параметров в {}, удалите все наборы {} если категория не нужна. Параметры: адрес сервера и токен.

* `prostream` - может быть массивом: добавьте ещё один набор параметров в {}, удалите все наборы {} если категория не нужна. Параметры: адрес сервера и порт.

* `rds` - может быть массивом: добавьте ещё один набор параметров в {}, удалите все наборы {} если категория не нужна. Параметры:

  * `device` = SmartGen, 8700i или LinkShare
  * `address` = ip-адрес кодера
  * `port` = номер порта
  * `porttype` = TCP, UDP (только для Deva SmartGen)
  * `NonMusic` = текст, который будет выводиться в RT если играет не песня (джингл, новости, программа)
  * `commercialText` = текст, который будет выводиться в RT если играет рекламный блок

* `ftp` - может быть массивом: добавьте ещё один набор параметров в {}, удалите все наборы {} если категория не нужна. Параметры: адрес сервера (и порт, если отличается от 21), имя пользователя, пароль, путь (должен начинаться и заканчиваться слэшем / )

Назначение параметров `rArtistID`, `rTitleID`, `altArtistID`, `altTitleID`, `DefaultAT`, `AltAT` см. ниже.

Перед использованием обязательно проверьте файл конфигурации любым json-валидатором. Не забывайте про запятые между элементы и их отсутствие у последнего элемента.

Если категория не нужна, оставьте пустой массив:
```json
    "ftp": [
    ],
```

Если в категорию нужно добавить ещё одного получателя, добавьте ещё один элемент массива:
```json
    "ftp": [
        {
            "pass": "password",
            "path": "/",
            "server": "127.0.0.1",
            "user": "anonymous"
        },
        {
            "pass": "password",
            "path": "/ftp-root/",
            "server": "localhost:21",
            "user": "radio"
        },
        {
            "pass": "password33",
            "path": "/pub/ftp/",
            "server": "127.0.0.2:8021",
            "user": "ftpuser"
        }
    ],
```


Настройка.
---------------------------
1. Отредактируйте файл конфигурации `example.cfg.json` и сохраните его в `myradio.cfg.json` в папку со скриптом (выберите соответствующее вашей радиостанции имя файла).

2. Файл `runps.bat` нужен для запуска PowerShell-скрипта из Джина. Этот файл должен находиться в рабочей папке с PS-скриптом, например, в "C:\Program Files (x86)\Digispot II\Uploader"
В связи с особенностями запуска приложений из Джина, в `runps.bat` необходим явный переход в папку, где находится скрипт.
На рабочую папку должны быть даны права на чтение, запись, удаление папок и файлов.

В файле runps.bat находится:
```Batchfile
@echo off
cd "C:\Program Files (x86)\Digispot II\Uploader"
title %1
echo %date% %time% %1 >> log\runps.log
powershell -NoProfile -ExecutionPolicy bypass -File "uploader3.06.000.ps1" %1 %2
::pause
```

Алгоритм работы:
----------------

* PS-скрипт запускается из скрипта FileMonitor.ps1 через "стартер" `runps3.bat` с именем файла конфигурации в виде обязательного параметра *без расширения .json*. Например: `runps3 myradio.cfg` запустит обработку спараметрами из файла `myradio.cfg.json`
* В рабочей папке создаются папки .\LOG и .\TMP
* Получается текущее время **$scriptstart**, когда запустился скрипт. Поскольку есть возможность запускать несколько экземпляров скрипта, сохраняющих информацию в один лог, это значение текущего времени в дальнейшем используется как идентификатор всего, что связано с текущим запущенным экземпляром скрипта.
* Создаётся локальная копия XML-файла с суффиксом **$scriptstart**.
* Создаётся массив, в котором будут храниться идентификатор потока (такой же как файл конфигурации, например myradio.cfg) и найденные песни.
* Из всех веток с идентификаторами элемента ELEM выбираются объекты с типом фонограммы = 3 (песня).
* Для каждого объекта "песня" выбираются значения: **Type**, **dbID**, **Artist**, **Name**, **Starttime**, **Runtime**.
* Поля Artist и Title в МБД могут быть заполнены транслитом. В этом случае предполагается использование пользовательских атрибутов МБД (User Attributes) с альтернативными названиями "Русский исполнитель" и "Русское название композиции". В файле конфигурации нужно указать `ALTAT=TRUE`, а в значениях `ALTATISTID` и `ALTTITLEID` необходимо указать соответствующие им ID. Эти значения ID пользовательских атрибутов можно посмотреть в вашем выгружаемом XML от Джина:
```XML
<root>
  <ELEM_0>
    <Elem>
      <UserAttribs>
        <ELEM>
          <ID dt="i4">7</ID>
          <Name>Русский исполнитель</Name>
          <Value>АЛЛА ПУГАЧЁВА</Value>
        </ELEM>
        <ELEM>
          <ID dt="i4">17</ID>
          <Name>Русское название композиции</Name>
          <Value>ПРОСТИ, ПОВЕРЬ</Value>
        </ELEM>
      </UserAttribs>
```
В обычном режиме в полях `Artist` и `Title` хранятся русские значения по умолчанию. В этом случае в файле конфигурации нужно указать `ALTAT=FALSE`, поиск по Пользовательским атрибутам проводиться не будет, для корректной отправки данных в RDS поля A/T будут транслитерированы. 


* Значение **Artist** приводится к нижнему регистру, затем к TitleCase (первая буква заглавная, остальные строчные).
* Значение **Name** приводится к нижнему регистру, затем к TitleCase (первая буква заглавная, остальные строчные).
* Значение **Runtime** переводится из миллисекунд в секунды и округляется в бо́льшую сторону.
* Значение **Starttime** переводится из миллисекунд с начала суток в количество секунд с 1.01.1970 0:00:00 (UnixTime) и из полученного значения вычитается часовой пояс (-10800 сек. для GMT+3)
* Если в файле конфигурации указано, что **Artist** и **Name** записаны транслитом и есть "альтернативные" русские названия, то происходит их поиск в соответствующих Пользовательских Атрибутах;
* Производится замена текста в строках **Artist** и **Name** по "хэш-таблице замены" - удаляются спец-префиксы *PI_*, *ID_EP LIVE*, *NEW_*, *MD_*, *EDIT_*; нижние подчёркивания заменяются на пробел; два пробела заменяются на один; заменяются исключения в регистре букв типа *ABBA*, *LP*, *DJ*, *OneRepublic*, *McCartney*

* Если текущий элемент (**ELEM**) песня, и его статус *Playing*, и значение **dbID** не равно *null*, то в массиве оставляются только три элемента - текущая песня и две следующие.
* Массив со значениями песен конвертируется в JSON и сохраняется в json-файл с текущим временем скрипта **$scriptstart**.
* Если текущий json-файл не отличается от "последнего удачного", то программа завершает работу.
  * При запуске скрипта с параметром `-force` (например из командной строки `uploader3.ps1 test.cfg -force`) программа форсированно продолжает работу.
* Если текущий json-файл отличается от "последнего удачного" и в файле конфигурации задана категория `JSONCUSTOM`, то происходит JSON POST и текущий json-файл сохраняется как "последний удачный".

* Получаются значения **Artist**, **Title** и **Type** для текущего элемента (ELEM).
* Если в файле конфигурации указано, что **Artist** и **Name** записаны транслитом и есть "альтернативные" русские названия, то происходит их поиск в соответствующих Пользовательских Атрибутах;

* Если текущий элемент (ELEM_0) имеет статус *Playing* и его тип "песня", то собирается строка для отправки в Omnia ProStream в формате "Artist - Name", а если тип "не песня", то строка будет пустой ("").
* Если в файле конфигурации задано действие `PROSTREAM`, то значение типа текущего элемента сравнивается с "последним удачным" значением типа. Если оно одинаковое (несколько джинглов или рекламных роликов подряд), то отправка метаданных в ProStream прекращается, иначе в ProStream с ip-адресом и портом из файла конфигурации отправляются текстовая строка в формате фильтра "Character Parser Sample" и значение типа текущего элемента сохраняется как "последнее удачное".

* Загрузка радиотекста в RDS происходит, если текущий элемент имеет статус *Playing* и в файле конфигурации задано действие `RDS`.
* Если значение типа текущего элемента равно *1* (реклама), то строка радиотекста составляется из значений "коммерческая информация" `commercialText` и "адрес сайта" `site` из файла конфигурации. Значение RT+ при этом обнуляется.
* Если значение типа текущего элемента равно *3* (музыка), то
  * Происходит транслитерация строк **Artist** и **Name**.
  * Строка радиотекста составляется в формате *Artist - Name :: адрес сайта*. В строку RT+ при этом записываются значения, относящиеся к **Artist** и **Name** из строки радиотекста.
* Если значение типа текущего элемента не равно *1* или *2* (джингл, программа, новости), то строка радиотекста составляется из значения "немузыкальная информация" `nonMusic` и "адрес сайта" `site` из файла конфигурации. Значение RT+ при этом обнуляется.
* Значение типа текущего элемента сравнивается с "последним удачным" значением типа. Если оно одинаковое (несколько джинглов или рекламных роликов подряд), то загрузка радиотекста в RDS прекращается.
  * Если в скрипте установлен флаг $force = $true, то программа форсированно продолжает работу.
* Иначе в RDS-кодер с ip-адресом и портом из файла конфигурации отправляются строка RT и RT+; значение типа текущего элемента сохраняется как "последнее удачное".
  * При значении `"porttype": "UDP"` в файле конфигурации строка отправляется в указанный порт по UDP, при значении `"porttype": "TDP"` - по TCP.

* Если в файле конфигурации задано действие `FTP`, и текущий элемент (ELEM_0) имеет статус *Playing*, то выполняется отправка локальной копии XML-файла под оригинальным именем на FTP-сервер.

* В лог-файл `.\LOG\%DATE%-myradio.cfg.log` сохраняются отчёты и комментарии о всех основных действиях скрипта.


Пример лога:
------------
```INI
17:47:23.466 : *** : 20200825-174723-435 Script started 
17:47:23.810 :     : 20200825-174723-435 Now playing : 2/  - J 01 2019 Shotgun 3
17:47:23.856 :     : 20200825-174723-435 Forced RDS string is not found.
17:47:23.872 :     : 20200825-174723-435 ProStream Now Playing: 2/  - J 01 2019 Shotgun 3
17:47:23.919 : [+] : 20200825-174723-435 PROSTREAM1  string t=
 sent to 127.0.0.1: 6002
17:47:23.934 : [+] : 20200825-174723-435 PROSTREAM2  string t=
 sent to 127.0.0.2 : 6002
17:47:24.012 :     : 20200825-174723-435 Transliterated artist  and title J 01 2019 Shotgun 3
17:47:24.012 :     : 20200825-174723-435 RDS Now Playing: 2/  - J 01 2019 Shotgun 3
17:47:24.028 :     : 20200825-174723-435 Temp NOWPLAYING file: C:\Program Files (x86)\Digispot II\Uploader\jsons\ep.cfg.20200825-174723-435.rds-current.txt 
17:47:24.184 : [+] : 20200825-174723-435 RDS  string TEXT=Europa Plus ** www.europaplus.ru
RT+TAG=04,00,00,01,00,00,1,1
 sent ( 67 bytes) to 127.0.0.1: 5001
17:47:24.356 : [*] : 20200825-174723-435  Script finished normally
17:47:27.304 : *** : 20200825-174727-273 Script started 
17:47:27.647 :     : 20200825-174727-273 Now playing : 3/ Stefy De Cicco & Ben Hamilton - Day 'N' Nite (Martin Jensen Edit)
17:47:27.694 :     : 20200825-174727-273 Forced RDS string is not found.
17:47:27.725 :     : 20200825-174727-273 JSON saved to C:\Program Files (x86)\Digispot II\Uploader\jsons\ep.cfg.20200825-174727-273.json.
17:47:28.271 : [+] : 20200825-174727-273 JSON  push engaged. AT: Stefy De Cicco & Ben Hamilton Day 'N' Nite (Martin Jensen Edit) Element: 3, Status: playing), JSON=TRUE
17:47:28.302 :     : 20200825-174727-273 ProStream Now Playing: 3/ Stefy De Cicco & Ben Hamilton - Day 'N' Nite (Martin Jensen Edit)
17:47:28.396 : [+] : 20200825-174727-273 PROSTREAM1  string t=Stefy De Cicco & Ben Hamilton - Day 'N' Nite (Martin Jensen Edit)
 sent to 127.0.0.1: 6002
17:47:28.412 : [+] : 20200825-174727-273 PROSTREAM2  string t=Stefy De Cicco & Ben Hamilton - Day 'N' Nite (Martin Jensen Edit)
 sent to 127.0.0.2: 6002
17:47:28.692 :     : 20200825-174727-273 Transliterated artist Stefy De Cicco & Ben Hamilton and title Day 'N' Nite (Martin Jensen Edit)
17:47:28.708 :     : 20200825-174727-273 RDS Now Playing: 3/ Stefy De Cicco & Ben Hamilton - Day 'N' Nite (Martin Jensen Edit)
17:47:28.708 :     : 20200825-174727-273 Temp NOWPLAYING file: C:\Program Files (x86)\Digispot II\Uploader\jsons\ep.cfg.20200825-174727-273.rds-current.txt 
17:47:28.755 : [+] : 20200825-174727-273 RDS  string TEXT=Stefy De Cicco & Ben Hamilton - Day 'N' Nite (Martin Jensen Edit) ** www.europaplus.ru
RT+TAG=04,00,29,01,32,33,1,1
 sent ( 121 bytes) to 127.0.0.1: 5001
17:47:29.722 : [+] : 20200825-174727-273 FTP1  upload of C:\Program Files (x86)\Digispot II\Uploader\tmp\EP-MSK2v3.xml.20200825-174727-273 to metadata.emgsound.ru OK
17:47:29.831 : [*] : 20200825-174727-273  Script finished normally
17:50:01.341 : *** : 20200825-175001-310 Script started 
17:50:01.669 :     : 20200825-175001-310 Now playing : 3/ Stefy De Cicco & Ben Hamilton - Day 'N' Nite (Martin Jensen Edit)
17:50:01.685 :     : 20200825-175001-310 Forced RDS string is not found.
17:50:01.716 :     : 20200825-175001-310 JSON saved to C:\Program Files (x86)\Digispot II\Uploader\jsons\ep.cfg.20200825-175001-310.json.
17:50:01.716 : [x] : 20200825-175001-310  Previous and current JSONs are same
17:50:01.731 : [x] : 20200825-175001-310  Script breaks
17:50:04.399 : *** : 20200825-175004-368 Script started 
17:50:04.773 :     : 20200825-175004-368 Now playing : 3/ Stefy De Cicco & Ben Hamilton - Day 'N' Nite (Martin Jensen Edit)
17:50:04.836 :     : 20200825-175004-368 Forced RDS string is not found.
17:50:04.883 :     : 20200825-175004-368 JSON saved to C:\Program Files (x86)\Digispot II\Uploader\jsons\ep.cfg.20200825-175004-368.json.
17:50:04.898 : [x] : 20200825-175004-368  Previous and current JSONs are same
17:50:04.898 : [x] : 20200825-175004-368  Script breaks
17:50:07.067 : *** : 20200825-175007-036 Script started 
17:50:07.410 :     : 20200825-175007-036 Now playing : 3/ Stefy De Cicco & Ben Hamilton - Day 'N' Nite (Martin Jensen Edit)
17:50:07.457 :     : 20200825-175007-036 Forced RDS string is not found.
17:50:07.488 :     : 20200825-175007-036 JSON saved to C:\Program Files (x86)\Digispot II\Uploader\jsons\ep.cfg.20200825-175007-036.json.
17:50:07.504 : [x] : 20200825-175007-036  Previous and current JSONs are same
17:50:07.519 : [x] : 20200825-175007-036  Script breaks
17:50:08.674 : *** : 20200825-175008-658 Script started 
17:50:08.876 :     : 20200825-175008-658 Now preloaded : 2/  - Vlet
17:50:08.923 :     : 20200825-175008-658 Forced RDS string is not found.
17:50:08.986 : [*] : 20200825-175008-658  Script finished normally
```

Версии:
-------
V3.00.002 2020-02-25 исправления

V3.00.001 2020-02-16 начальная версия: в качестве источника для XML используется встроенный в Джин механизм "Что играет в плеере XML", формат "расширенный" v3.0

V3.01.003 2020-08-25 добавлена опция, определяющая в основных или альтернативных полях карточки МБД содержатся русские A/T; транслитерация для RDS

V3.02.001 2022-02-10 добавлена отправка RDS в FM-процессоры Sound4 по протоколу Link&Share; небольшие улучшения RT+ для SmartGen.

V3.03.001 2022-07-11 теперь XML выгружается на FTP если статус блока Playing, без прочих условий.

V3.04.001 2024-11-13 добавлено сохранение на локальный диск JSON с полем "Artist - Title" для вывода на LED-экран ("бегущую строку").

V3.05.000 2024-11-19 добавлена отправка XML через POST-запрос.

V3.06.000 2024-12-23 BREAKING CHANGE: файл конфигурации теперь в JSON; обработка неограниченного количества получателей в каждой категории.
