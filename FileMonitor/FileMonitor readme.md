FileMonitor 1.08
==================
04.04.2025 Roman Ermakov <r.ermakov@emg.fm>

Программа предназначена для мониторинга папки на предмет изменённых XML-файлов с метаданными от Джин и запуска соответствующего обработчика uploader2.ps1 или uploader3.ps1.

Для определения соответствия между XML, обработчиком (uploader) и файлом конфигурации используется массив `$ConfigTable`:
```powershell
$ConfigTable = @(
    [PSCustomObject]@{ Xml = 'РЕТРО-МОСКВА.xml';     Cfg = 'rr-v3.cfg';           Dst = 'RR-MSKv3.xml';        Exe = '.\runps3.bat' },
    [PSCustomObject]@{ Xml = 'РЕТРО_FM-70.xml';      Cfg = 'rr-70-v3.cfg';        Dst = 'RR-INTERNET_1v3.xml'; Exe = '.\runps3.bat' },
    [PSCustomObject]@{ Xml = 'РЕТРО_FM-80.xml';      Cfg = 'rr-80-v3.cfg';        Dst = 'RR-INTERNET_2v3.xml'; Exe = '.\runps3.bat' },
    [PSCustomObject]@{ Xml = 'РЕТРО_FM-90.xml';      Cfg = 'rr-90-v3.cfg';        Dst = 'RR-INTERNET_3v3.xml'; Exe = '.\runps3.bat' },

```
Отредактируйте этот массив исходя из ваших файлов. Запятая после последней закрывающей фигурной скобки } не нужна!

* При изменении РЕТРО-МОСКВА.xml, этот файл может быть скопирован с именем UPLOAD/RR-MSKv3.xml (отключено в скрипте), и будет запущен `runps3.bat rr-v3.cfg`

Runps - bat-стартер для powershell-скрипта uploader2.ps1 (XML от Джин.ValueServer) или uploader3.ps1 (XML от
[Что играет в плеере XML 3.0](https://redmine.digispot.ru/projects/digispot/wiki/%D0%A7%D1%82%D0%BE_%D0%B8%D0%B3%D1%80%D0%B0%D0%B5%D1%82_%D0%B2_%D0%BF%D0%BB%D0%B5%D0%B5%D1%80%D0%B5_%D0%B2_%D0%B2%D0%B8%D0%B4%D0%B5_XML_v_3_0 ))

FileMonitor.ps1 должен находиться в одной папке с файлами uploader2.ps1, uploader3.ps1, runps2.bat, runps3.bat и *.cfg

Для того чтобы в переменных имён файлов можно было использовать кириллицу, откройте скрипт в Блокноте и пересохраните как *UTF-8 With BOM*

Алгоритм работы:
----------------

* PS-скрипт запускается из скрипта FileMonitor.ps1 через "стартер" `runps3.bat` с именем файла конфигурации в виде обязательного параметра. Например: `runps3 myradio.cfg`
* В рабочей папке создаётся папка .\LOG
* При запуске скрипта есть возможность принудительно запустить обработчики (uploader) для всех файлов, указанных в конфигурации. Для этого нужно запустить скрипт с параметром -force: `.\FileMonitor.ps1 -force`
* Каждые 250 миллисекунд (значение устанавливается в переменной `$timeout`) скрипт следит за изменением *.xml-файлов по пути `$PathToMonitor`
* При изменении XML-файла, если он описан в массиве конфигурации `$ConfigTable`, XML копируется с новым именем, заданным в `Dst=`, и затем запускается соответствующий ему исполняемый файл `$ConfigTable.Exe` с параметром `$ConfigTable.Cfg` (например, `.\runps2.bat ep.cfg`)
* В лог-файл `.\LOG\%DATE%-Watcher.cfg` сохраняются отчёты о запуске обработчиков (uploader).

Версии:
-------
v1.08 2025-04-04 изменён способ отслеживания изменения файлов: теперь это polling с интервалом 250 мсек

v1.07 2025-03-30 отладочная версия

v1.06 2020-02-10 удалено слежение за работой DJin.ValueServer; 

v1.05 2020-02-27 файлы с кириллицей в именах переименовываются из $ConfigTable.Xml в $ConfigTable.Dst

v1.04 2020-02-25 улучшены логи

v1.03 2020-02-20 добавлен массив конфигурации для указания связи между файлами XML, .cfg и обработчиком (uploader).

v1.02 2020-02-18 исправлен поиск по соответствиям XML и $cfg.

v1.01 2020-02-03 добавлен контроль за процессом DJin.exe.

v1.00 2020-01-17 начальная версия.
